<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Storing Large Dataframes • git2rdata</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Storing Large Dataframes">
<meta property="og:description" content="git2rdata">
<meta property="og:image" content="/logo.svg">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">git2rdata</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../news/index.html">NEWS</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/plain_text.html">Getting started storing dataframes as plain text</a>
    </li>
    <li>
      <a href="../articles/version_control.html">Storing dataframes under version control</a>
    </li>
    <li>
      <a href="../articles/workflow.html">Potential workflow</a>
    </li>
    <li>
      <a href="../articles/efficiency.html">Efficiency</a>
    </li>
    <li>
      <a href="../articles/split_by.html">Large dataframes</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li>
  <a href="../CONTRIBUTING.html">Contributing</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ropensci/git2rdata">
    <span class="fas fa-github fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://twitter.com/INBOVlaanderen">
    <span class="fas fa-twitter fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://www.facebook.com/pg/INBOVlaanderen">
    <span class="fas fa-facebook fg-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="split_by_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Storing Large Dataframes</h1>
                        <h4 class="author">Thierry Onkelinx</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ropensci/git2rdata/blob/master/vignettes/split_by.Rmd"><code>vignettes/split_by.Rmd</code></a></small>
      <div class="hidden name"><code>split_by.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>Sometimes, a large dataframe has one or more variables with a small number of unique combinations. E.g. a dataframe with one or more factor variables. Storing the entire dataframe as a single text file requires storing lots of replicated data. Each row stores the information for every variable, even if a subset of these variables remains constant over a subset of the data.</p>
<p>In such a case we can use the <code>split_by</code> argument of <code><a href="../reference/write_vc.html">write_vc()</a></code>. This will store the large dataframe over a set of tab separated files. One file for every combination of the variables defined by <code>split_by</code>. Every partial data file holds the other variables for one combination of <code>split_by</code>. We remove the <code>split_by</code> variables from the partial data files, reducing their size. We add an <code>index.tsv</code> containing the combinations of the <code>split_by</code> variables and a unique hash for each combination. This hash becomes the base name of the partial data files.</p>
<p>Splitting the dataframe into smaller files makes them easier to handle in version control system. The total size depends on the amount of replication in the dataframe. More on that in the next section.</p>
</div>
<div id="when-to-split-the-dataframe" class="section level2">
<h2 class="hasAnchor">
<a href="#when-to-split-the-dataframe" class="anchor"></a>When to Split the Dataframe</h2>
<p>Let’s set the following variables:</p>
<ul>
<li><p><span class="math inline">\(s\)</span>: the average number of bytes to store a single line of the <code>split_by</code> variables.</p></li>
<li><p><span class="math inline">\(r\)</span>: the average number of bytes to store a single line of the remaining variables.</p></li>
<li><p><span class="math inline">\(h_s\)</span>: the number of bytes to store the header of the <code>split_by</code> variables.</p></li>
<li><p><span class="math inline">\(h_r\)</span>: the number of bytes to store the header of the remaining variables.</p></li>
<li><p><span class="math inline">\(N\)</span>: the number of rows in the dataframe.</p></li>
<li><p><span class="math inline">\(N_s\)</span>: the number of unique combinations of the <code>split_by</code> variables.</p></li>
</ul>
<p>Storing the dataframe with <code><a href="../reference/write_vc.html">write_vc()</a></code> without <code>split_by</code> requires <span class="math inline">\(h_s + h_r + 1\)</span> bytes for the header and <span class="math inline">\(s + r + 1\)</span> bytes for every observation. The total number of bytes is <span class="math inline">\(T_0 = h_s + h_r + 1 + N (s + r + 1)\)</span>. Both <span class="math inline">\(+ 1\)</span> originate from the tab character to separate the <code>split_by</code> variables from the remaining variables.</p>
<p>Storing the dataframe with <code><a href="../reference/write_vc.html">write_vc()</a></code> with <code>split_by</code> requires an index file to store the combinations of the <code>split_by</code> variables. It will use <span class="math inline">\(h_s\)</span> bytes for the header and <span class="math inline">\(N_s s\)</span> for the data. The headers of the partial data files require <span class="math inline">\(N_s h_r\)</span> bytes (<span class="math inline">\(N_s\)</span> files and <span class="math inline">\(h_r\)</span> byte per file). The data in the partial data files require <span class="math inline">\(N r\)</span> bytes. The total number of bytes is <span class="math inline">\(T_s = h_s + N_s s + N_s h_r + N r\)</span>.</p>
<p>We can look at the ratio of <span class="math inline">\(T_s\)</span> over <span class="math inline">\(T_0\)</span>.</p>
<p><span class="math display">\[\frac{T_s}{T_0} = \frac{h_s + N_s s + N_s h_r + N r}{h_s + h_r + 1 + N (s + r + 1)}\]</span></p>
<p>Let’s simplify the equation by assuming that we need an equal amount of character for the headers and the data (<span class="math inline">\(h_s = s\)</span> and <span class="math inline">\(h_r = r\)</span>).</p>
<p><span class="math display">\[\frac{T_s}{T_0} = \frac{s + N_s s + N_s r + N r}{s + r + 1 + N (s + r + 1)}\]</span></p>
<p><span class="math display">\[\frac{T_s}{T_0} = \frac{s + N_s s + N_s r + N r}{s + r + 1 + N s + N r + N}\]</span></p>
<p>Let assume that <span class="math inline">\(s = a r\)</span> with <span class="math inline">\(0 &lt; a\)</span> and <span class="math inline">\(N_s = b N\)</span> with <span class="math inline">\(0 &lt; b &lt; 1\)</span>.</p>
<p><span class="math display">\[\frac{T_s}{T_0} = \frac{a r + N a b r + N b r + N r}{a r + r + 1 + N a r + N r + N}\]</span></p>
<p><span class="math display">\[\frac{T_s}{T_0} = \frac{(a + N a b + N b + N) r}{(N + 1) (a r + r + 1)}\]</span></p>
<p><span class="math display">\[\frac{T_s}{T_0} = \frac{a + N a b + N b + N}{(N + 1) (a + 1 + 1 / r)}\]</span> <span class="math display">\[\frac{T_s}{T_0} = \frac{a + (a b + b + 1) N }{(N + 1) (a + 1 + 1 / r)}\]</span></p>
<p>When <span class="math inline">\(N\)</span> is large, we can state that <span class="math inline">\(a \lll N\)</span> and <span class="math inline">\(N / (N + 1) \approx 1\)</span>.</p>
<p><span class="math display">\[\frac{T_s}{T_0} \approx \frac{a b + b + 1}{a + 1 + 1 / r}\]</span></p>
<div class="figure">
<img src="split_by_files/figure-html/ratio-1.png" alt="Storage space required using `split_by` relative to storing a single file." width="576"><p class="caption">
Storage space required using <code>split_by</code> relative to storing a single file.
</p>
</div>
<p>The figure illustrates that using <code>split_by</code> is more efficient when the number of unique combinations (<span class="math inline">\(N_s\)</span>) of the <code>split_by</code> variables is much smaller than the number of rows in the dataframe (<span class="math inline">\(N\)</span>). The efficiency also increases when the storage for a single combination of <code>split_by</code> variables (<span class="math inline">\(s\)</span>) is larger than the storage needed for a single line of the remain variables (<span class="math inline">\(r\)</span>). The storage needed for a single line of the remain variables (<span class="math inline">\(r\)</span>) doesn’t influence the efficiency.</p>
</div>
<div id="benchmarking" class="section level2">
<h2 class="hasAnchor">
<a href="#benchmarking" class="anchor"></a>Benchmarking</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ropensci.github.io/git2rdata/">git2rdata</a></span><span class="op">)</span>
<span class="va">root</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span><span class="op">(</span><span class="st">"git2rdata-split-by"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span><span class="op">(</span><span class="va">root</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/joshuaulrich/microbenchmark/">microbenchmark</a></span><span class="op">)</span>
<span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>
  part_1 <span class="op">=</span> <span class="fu"><a href="../reference/write_vc.html">write_vc</a></span><span class="op">(</span><span class="va">airbag</span>, <span class="st">"part_1"</span>, <span class="va">root</span>, sorting <span class="op">=</span> <span class="st">"X"</span><span class="op">)</span>,
  part_2 <span class="op">=</span> <span class="fu"><a href="../reference/write_vc.html">write_vc</a></span><span class="op">(</span><span class="va">airbag</span>, <span class="st">"part_2"</span>, <span class="va">root</span>, sorting <span class="op">=</span> <span class="st">"X"</span>, split_by <span class="op">=</span> <span class="st">"airbag"</span><span class="op">)</span>,
  part_3 <span class="op">=</span> <span class="fu"><a href="../reference/write_vc.html">write_vc</a></span><span class="op">(</span><span class="va">airbag</span>, <span class="st">"part_3"</span>, <span class="va">root</span>, sorting <span class="op">=</span> <span class="st">"X"</span>, split_by <span class="op">=</span> <span class="st">"abcat"</span><span class="op">)</span>,
  part_4 <span class="op">=</span> <span class="fu"><a href="../reference/write_vc.html">write_vc</a></span><span class="op">(</span>
    <span class="va">airbag</span>, <span class="st">"part_4"</span>, <span class="va">root</span>, sorting <span class="op">=</span> <span class="st">"X"</span>, split_by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"airbag"</span>, <span class="st">"sex"</span><span class="op">)</span>
  <span class="op">)</span>,
  part_5 <span class="op">=</span> <span class="fu"><a href="../reference/write_vc.html">write_vc</a></span><span class="op">(</span><span class="va">airbag</span>, <span class="st">"part_5"</span>, <span class="va">root</span>, sorting <span class="op">=</span> <span class="st">"X"</span>, split_by <span class="op">=</span> <span class="st">"dvcat"</span><span class="op">)</span>,
  part_6 <span class="op">=</span> <span class="fu"><a href="../reference/write_vc.html">write_vc</a></span><span class="op">(</span>
    <span class="va">airbag</span>, <span class="st">"part_6"</span>, <span class="va">root</span>, sorting <span class="op">=</span> <span class="st">"X"</span>, split_by <span class="op">=</span> <span class="st">"yearacc"</span>
  <span class="op">)</span>,
  part_15 <span class="op">=</span> <span class="fu"><a href="../reference/write_vc.html">write_vc</a></span><span class="op">(</span>
    <span class="va">airbag</span>, <span class="st">"part_15"</span>, <span class="va">root</span>, sorting <span class="op">=</span> <span class="st">"X"</span>, split_by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"dvcat"</span>, <span class="st">"abcat"</span><span class="op">)</span>
  <span class="op">)</span>,
  part_45 <span class="op">=</span> <span class="fu"><a href="../reference/write_vc.html">write_vc</a></span><span class="op">(</span>
    <span class="va">airbag</span>, <span class="st">"part_45"</span>, <span class="va">root</span>, sorting <span class="op">=</span> <span class="st">"X"</span>, split_by <span class="op">=</span> <span class="st">"yearVeh"</span>
  <span class="op">)</span>,
  part_270 <span class="op">=</span> <span class="fu"><a href="../reference/write_vc.html">write_vc</a></span><span class="op">(</span>
    <span class="va">airbag</span>, <span class="st">"part_270"</span>, <span class="va">root</span>, sorting <span class="op">=</span> <span class="st">"X"</span>, split_by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"yearacc"</span>, <span class="st">"yearVeh"</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span>
<span class="va">mb</span><span class="op">$</span><span class="va">time</span> <span class="op">&lt;-</span> <span class="va">mb</span><span class="op">$</span><span class="va">time</span> <span class="op">/</span> <span class="fl">1e6</span></code></pre></div>
<p>Splitting the dataframe over more than one file takes more time to write the data. The log time seems to increase quadratic with log number of parts.</p>
<div class="figure">
<img src="split_by_files/figure-html/plot_write_timings-1.png" alt="Boxplot of the write timings for different number of parts." width="576"><p class="caption">
Boxplot of the write timings for different number of parts.
</p>
</div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mb_r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>
  part_1 <span class="op">=</span> <span class="fu"><a href="../reference/read_vc.html">read_vc</a></span><span class="op">(</span><span class="st">"part_1"</span>, <span class="va">root</span><span class="op">)</span>,
  part_2 <span class="op">=</span> <span class="fu"><a href="../reference/read_vc.html">read_vc</a></span><span class="op">(</span><span class="st">"part_2"</span>, <span class="va">root</span><span class="op">)</span>,
  part_3 <span class="op">=</span> <span class="fu"><a href="../reference/read_vc.html">read_vc</a></span><span class="op">(</span><span class="st">"part_3"</span>, <span class="va">root</span><span class="op">)</span>,
  part_4 <span class="op">=</span> <span class="fu"><a href="../reference/read_vc.html">read_vc</a></span><span class="op">(</span><span class="st">"part_4"</span>, <span class="va">root</span><span class="op">)</span>,
  part_5 <span class="op">=</span> <span class="fu"><a href="../reference/read_vc.html">read_vc</a></span><span class="op">(</span><span class="st">"part_5"</span>, <span class="va">root</span><span class="op">)</span>,
  part_6 <span class="op">=</span> <span class="fu"><a href="../reference/read_vc.html">read_vc</a></span><span class="op">(</span><span class="st">"part_6"</span>, <span class="va">root</span><span class="op">)</span>,
  part_15 <span class="op">=</span> <span class="fu"><a href="../reference/read_vc.html">read_vc</a></span><span class="op">(</span><span class="st">"part_15"</span>, <span class="va">root</span><span class="op">)</span>,
  part_45 <span class="op">=</span> <span class="fu"><a href="../reference/read_vc.html">read_vc</a></span><span class="op">(</span><span class="st">"part_45"</span>, <span class="va">root</span><span class="op">)</span>,
  part_270 <span class="op">=</span> <span class="fu"><a href="../reference/read_vc.html">read_vc</a></span><span class="op">(</span><span class="st">"part_270"</span>, <span class="va">root</span><span class="op">)</span>
<span class="op">)</span>
<span class="va">mb_r</span><span class="op">$</span><span class="va">time</span> <span class="op">&lt;-</span> <span class="va">mb_r</span><span class="op">$</span><span class="va">time</span> <span class="op">/</span> <span class="fl">1e6</span></code></pre></div>
<p>A small number of parts does not seem to affect the read timings much. Above ten parts, the required time for reading seems to increase. The log time seems to increase quadratic with log number of parts.</p>
<div class="figure">
<img src="split_by_files/figure-html/plot_read_timings-1.png" alt="Boxplot of the read timings for the different number of parts." width="576"><p class="caption">
Boxplot of the read timings for the different number of parts.
</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://www.muscardinus.be">Thierry Onkelinx</a>, <a href="https://www.inbo.be/en"><img src="https://ropensci.github.io/git2rdata/reference/figures/logo-en.png" height="24"></a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
